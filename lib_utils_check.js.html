<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/utils/check.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">HOME</a></h2><h2><a href="api-overview.html">API OVERVIEW</a></h2><h3>Modules</h3><ul><li><a href="module-app_controller.html">app/controller</a></li><li><a href="module-lib_fsm.html">lib/fsm</a></li><li><a href="module-lib_json.html">lib/json</a><ul class='methods'><li data-type='method'><a href="module-lib_json.html#.deserialize">deserialize</a></li><li data-type='method'><a href="module-lib_json.html#.serialize">serialize</a></li></ul></li><li><a href="module-lib_layoutFsm.html">lib/layoutFsm</a></li><li><a href="module-lib_utils_descriptor.html">lib/utils/descriptor</a></li><li><a href="module-lib_utils_iterator.html">lib/utils/iterator</a><ul class='methods'><li data-type='method'><a href="module-lib_utils_iterator.html#.empty">empty</a></li><li data-type='method'><a href="module-lib_utils_iterator.html#.flatten">flatten</a></li><li data-type='method'><a href="module-lib_utils_iterator.html#.hijack">hijack</a></li><li data-type='method'><a href="module-lib_utils_iterator.html#.wrap">wrap</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="module-lib_fsm-Fsm.html">lib/fsm~Fsm</a></li><li><a href="module-lib_fsm-Fsm-State.html">lib/fsm~Fsm~State</a><ul class='methods'><li data-type='method'><a href="module-lib_fsm-Fsm-State.html#.add">add</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-State.html#.all">all</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-State.html#.remove">remove</a></li></ul></li><li><a href="module-lib_fsm-Fsm-Symbol.html">lib/fsm~Fsm~Symbol</a><ul class='methods'><li data-type='method'><a href="module-lib_fsm-Fsm-Symbol.html#.add">add</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Symbol.html#.all">all</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Symbol.html#.remove">remove</a></li></ul></li><li><a href="module-lib_fsm-Fsm-Transition.html">lib/fsm~Fsm~Transition</a><ul class='methods'><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.add">add</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.all">all</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.get">get</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.groups">groups</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.remove">remove</a></li><li data-type='method'><a href="module-lib_fsm-Fsm-Transition.html#.select">select</a></li></ul></li><li><a href="module-lib_layoutFsm-Fsm.html">lib/layoutFsm~Fsm</a></li><li><a href="module-lib_layoutFsm-Fsm-State.html">lib/layoutFsm~Fsm~State</a></li><li><a href="module-lib_layoutFsm-Fsm-Symbol.html">lib/layoutFsm~Fsm~Symbol</a><ul class='methods'><li data-type='method'><a href="module-lib_layoutFsm-Fsm-Symbol.html#.add">add</a></li><li data-type='method'><a href="module-lib_layoutFsm-Fsm-Symbol.html#.getFromLabel">getFromLabel</a></li><li data-type='method'><a href="module-lib_layoutFsm-Fsm-Symbol.html#.remove">remove</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/utils/check.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module lib/utils/descriptor
 * @requires lib/utils/customError
 */

export function check() {
  return new Check();
}

export function checkNow(value) {
  return new CheckNow(value);
}

const checkFunctions = {};

checkFunctions.ifNotMember = function(predicate) {
  value = this;
  if(!predicate(value)) {
    throw new NotMember(value);
  }
  return value;
};

checkFunctions.ifMissing = function() {
  value = this;
  if(typeof value === "undefined") {
    throw new Missing(value);
  }
  return value;
};

checkFunctions.ifWrongType = function(type, allowNull=false) {
  value = this;
  if(typeof value !== "undefined") {
    if(allowNull) {
      if(value !== null &amp;&amp; typeof value !== type) {
        throw new WrongType(value, type, true);
      }
    } else {
      if(value === null || typeof value !== type) {
        throw new WrongType(value, type, false);
      }
    }
  }
  return value;
};

checkFunctions.default = function(defaultValue) {
  value = this;
  if(typeof value === "undefined") {
    return defaultValue;
  }
  return value;
};

checkFunctions.default.terminates = true;

checkFunctions.definition = function(definition) {
  const value = this;
  if(value == null) {
    return {};
  }
  if(typeof value !== "object") {
    throw new WrongType(value, type, true);
  }
  const output = {};
  const errors = {};
  let result;
  for(let prop in definition) {
    let description = value[prop];
    if(description instanceof Check) {
      description = description.hold();
    }
    try {
      result = definition[prop](description);
      output[prop] = result;
    } catch(err) {
      if(err instanceof CheckError) {
        errors[prop] = err; 
      } else {
        throw err;
      }
    }
  }
  if(Object.keys(errors).length > 0) {
    throw new ObjectErrors(description, definition, errors);
  }
  return output;
};

checkFunctions.definition.terminates = true;

// checkFunction.array = function(check) {
//   const value = this;
//   const errors = [];
//   if(value == null) {
//     return [];
//   }
//   if(!Array.isArray(value)) {
//     throw new NotArray(value);
//   }
//   const output = value.forEach((v, i) => {
//     try {
//       const c = check(v);
//       return check(v);
//     }
//     return check(v);
//   });
// };

const lockedPropDescriptor = (value, writable=false) => {
  return {
    value,
    configurable: false,
    enumerable: false,
    writable,
  };
};

// Check

const queueToken = Symbol("queue");

function Check() {
  Object.defineProperty(
    this, queueToken, lockedPropDescriptor([]));
}

const properties = {};

const bindCheckFunction = (checkFunction, ...args) => {
  return (value) => {
    checkFunction.apply(value, ...args);
  };
};

const resolveCheck = function(value) {
  for(f of this[queueToken]) {
    value = f(value);
  }
  return value;
};

const makeCheckProperty = (prop, terminates) => {
  if(terminates) {
    return lockedPropDescriptor(function(...args) {
      this[queueToken].push(bindCheckFunction(checkFunctions[prop], ...args));
      return resolveCheck.bind(this);
    });
  }
  return lockedPropDescriptor(function(...args) {
    this[queueToken].push(bindCheckFunction(checkFunctions[prop], ...args));
    return this;
  });
};

properties.resolve = lockedPropDescriptor(resolveCheck);

properties.hold = lockedPropDescriptor(function() {
  return resolveCheck.bind(this);
});

// CheckNow

const valueToken = Symbol("value");

function CheckNow(value) {
  Object.defineProperty(
    this, valueToken, lockedPropDescriptor(value, true));
}

const propertiesNow = {};

propertiesNow.done = lockedPropDescriptor(function() {
  return this[valueToken];
});

const makeCheckNowProperty = (prop, terminates) => {
  if(terminates) {
    return lockedPropDescriptor(function(...args) {
      return checkFunctions[prop].apply(this[valueToken], args);
    });
  }
  return lockedPropDescriptor(function(...args) {
    this[valueToken] = checkFunctions[prop].apply(this[valueToken], args);
    return this;
  });
};

// Builder properties

for(let prop in checkFunctions) {
  properties[prop] = makeCheckProperty(
    prop, checkFunction[prop].terminates);
  propertiesNow[prop] = makeCheckNowProperty(
    prop, checkFunction[prop].terminates);
}

// Termination


Object.defineProperties(Check.prototype, properties);
Object.defineProperties(CheckNow.prototype, propertiesNow);

export class CheckError extends Error {
  constructor(value) {
    super();
    this.name = this.constructor.name;
    this.value = value;
  }
  static throw(...args) {
    throw new this(...args);
  }
}

class NotMember extends CheckError {
  get message() {
    return "Not a member of the collection";
  }
}

class WrongType extends CheckError {
  constructor(value, type, allowNull=false) {
    super(value);
    this.type = type;
    this.allowNull = allowNull;
  }
  get message() {
    if(value == null &amp;&amp; !this.allowNull &amp;&amp; type === "object") {
      return "Should not be a null object";
    }
    return `Should be of type ${this.type}`;
  }
}

class Missing extends CheckError {
  get message() {
    return "Should be defined";
  }
}

class ObjectErrors extends CheckError {
  constructor(descriptor, definition, errors) {
    super(descriptor);
    this.definition = definition;
    this.errors = errors;
  }
  get message() {
    let m = "Errors on the following properties: ";
    for(let prop in err) {
      m += `\n    ${prop}: ${this.erros[prop].message}`;
    }
    return m;
  }
}

class ArrayErrors extends CheckError {
  constructor(descriptor, definition, errors) {
    super(descriptor);
    this.definition = definition;
    this.errors = errors;
  }
  get message() {
    let m = "Errors on the following indexes: ";
    errors.map((err, i) => {
      if(err != null) {
        m += `\n    ${i}: ${err.message}`;
      }
    });
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Apr 14 2016 15:27:39 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
